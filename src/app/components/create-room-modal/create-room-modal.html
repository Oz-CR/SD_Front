<!-- Modal Overlay -->
<div class="modal-overlay" [class.active]="isVisible" (click)="closeModal()">
  <!-- Modal Content -->
  <div class="modal-content" (click)="$event.stopPropagation()">
    <!-- Modal Header -->
    <div class="modal-header">
      <div class="modal-title">
        <div class="title-badge">
          <span class="badge-icon">üéÆ</span>
          Nueva Partida
        </div>
        <h2>Crear Partida</h2>
        <p class="modal-subtitle">Configura tu partida de Simon Says - ¬°Sin l√≠mites!</p>
      </div>
      <button class="close-button" (click)="closeModal()">
        <span>&times;</span>
      </button>
    </div>

    <!-- Modal Body -->
    <div class="modal-body">
      <form class="create-room-form" (ngSubmit)="onSubmit()" #form="ngForm">
        <!-- Campo Nombre de la Partida -->
        <div class="form-group">
          <label class="form-label" for="name">Nombre de la Partida</label>
          <input
            type="text"
            id="name"
            name="name"
            class="form-input"
            placeholder="Ingresa el nombre de tu partida"
            [(ngModel)]="roomData.name"
            required
            #nameInput="ngModel"
            maxlength="30"
          />
          <div
            class="error-message"
            *ngIf="nameInput.invalid && nameInput.touched"
          >
            El nombre de la partida es requerido
          </div>
        </div>

        <!-- Selector de Modo -->
        <div class="form-group">
          <label class="form-label">Configuraci√≥n de Colores</label>
          <div class="color-mode-selector">
            <button 
              type="button" 
              class="mode-btn"
              [class.active]="!isCustomColors"
              (click)="toggleCustomColors()"
            >
              <span class="mode-icon">üî¢</span>
              Cantidad de Colores
            </button>
            <button 
              type="button" 
              class="mode-btn"
              [class.active]="isCustomColors"
              (click)="toggleCustomColors()"
            >
              <span class="mode-icon">üé®</span>
              Colores Personalizados
            </button>
          </div>
        </div>

        <!-- Campo Cantidad de Colores (Modo R√°pido) -->
        <div class="form-group" *ngIf="!isCustomColors">
          <label class="form-label" for="colorCount">Cantidad de Colores</label>
          <input
            type="number"
            id="colorCount"
            name="colorCount"
            class="form-input"
            placeholder="Cantidad de colores (m√≠nimo 2, sin l√≠mite m√°ximo)"
            [(ngModel)]="roomData.colorCount"
            min="2"
            [max]="availableColors.length"
            required
            #colorCountInput="ngModel"
          />
          <div
            class="error-message"
            *ngIf="colorCountInput.touched && roomData.colorCount! < 2"
          >
            La cantidad de colores debe ser al menos 2
          </div>
          <div
            class="info-message"
            *ngIf="colorCountInput.valid && roomData.colorCount! >= 2"
          >
            ¬°Perfecto! Usar√°s {{ roomData.colorCount }} colores (m√°ximo disponible: {{ availableColors.length }})
          </div>
        </div>

        <!-- Selector de Colores Personalizados -->
        <div class="form-group" *ngIf="isCustomColors">
          <div class="colors-header">
            <label class="form-label">Selecciona tus colores ({{ getSelectedColorsCount() }} de {{ availableColors.length }} disponibles)</label>
            
            <!-- FIXED: Controles para seleccionar/deseleccionar todos -->
            <div class="color-controls">
              <button 
                type="button" 
                class="control-btn select-all"
                (click)="selectAllColors()"
                [disabled]="areAllColorsSelected()"
              >
                <span class="control-icon">‚úÖ</span>
                Todos
              </button>
              <button 
                type="button" 
                class="control-btn clear-all"
                (click)="clearAllColors()"
                [disabled]="getSelectedColorsCount() === 0"
              >
                <span class="control-icon">‚ùå</span>
                Ninguno
              </button>
            </div>
          </div>
          
          <!-- Indicador de carga -->
          <div *ngIf="isLoadingColors" class="loading-colors">
            <div class="loading-spinner"></div>
            Cargando colores disponibles...
          </div>
          
          <!-- Grid de colores -->
          <div class="colors-grid" *ngIf="!isLoadingColors">
            <div 
              *ngFor="let color of availableColors; trackBy: trackByColorName" 
              class="color-option"
              [class.selected]="isColorSelected(color.name)"
              (click)="toggleColorSelection(color.name)"
            >
              <div 
                class="color-circle"
                [style.background-color]="color.hexColor"
              ></div>
              <span class="color-name">{{ color.displayName }}</span>
              <div class="selection-indicator" *ngIf="isColorSelected(color.name)">‚úì</div>
            </div>
          </div>
          
          <!-- Mensaje de validaci√≥n para colores personalizados -->
          <div 
            class="error-message" 
            *ngIf="isCustomColors && getSelectedColorsCount() < 2"
          >
            Debes seleccionar al menos 2 colores
          </div>
          
          <div 
            class="success-message" 
            *ngIf="isCustomColors && getSelectedColorsCount() >= 2"
          >
            <span class="success-icon">üéâ</span>
            ¬°Incre√≠ble! Has seleccionado {{ getSelectedColorsCount() }} colores. ¬°Sin l√≠mites!
          </div>

          <!-- FIXED: Estad√≠sticas de selecci√≥n -->
          <div class="selection-stats" *ngIf="isCustomColors && getSelectedColorsCount() > 0">
            <div class="stat-item">
              <span class="stat-label">Seleccionados:</span>
              <span class="stat-value">{{ getSelectedColorsCount() }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Disponibles:</span>
              <span class="stat-value">{{ availableColors.length }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Progreso:</span>
              <span class="stat-value">{{ ((getSelectedColorsCount() / availableColors.length) * 100).toFixed(0) }}%</span>
            </div>
          </div>
        </div>

        <!-- Informaci√≥n de Dificultad -->
        <div class="difficulty-info">
          <div class="info-card" [class.extreme]="(isCustomColors ? getSelectedColorsCount() : roomData.colorCount) > 10">
            <div class="info-icon">‚ö°</div>
            <div class="info-content">
              <h4>Dificultad: {{ getDifficultyLabel() }}</h4>
              <p>{{ getDifficultyDescription() }}</p>
            </div>
          </div>
        </div>

        <!-- Modal Footer -->
        <div class="modal-footer">
          <button type="button" class="btn-secondary" (click)="closeModal()">
            Cancelar
          </button>
          <button type="submit" class="btn-primary" [disabled]="!isFormValid()">
            <span class="btn-icon">üöÄ</span>
            Crear Partida
          </button>
        </div>
      </form>
    </div>
  </div>
</div>